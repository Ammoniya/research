"""Configuration for vulnerability mining operations."""

import os
from dataclasses import dataclass
from typing import Optional


@dataclass
class MinerConfig:
    """Configuration for historical vulnerability mining."""

    # Input directories
    svn_repos_dir: str = os.environ.get(
        'SVN_REPOS_DIR',
        '/home/ravindu/compweb/svn_wordpress_org'
    )
    signatures_dir: str = 'signatures'

    # Output directories
    mining_output_dir: str = 'mining_results'
    timelines_dir: str = 'mining_results/timelines'
    zero_days_dir: str = 'mining_results/zero_days'
    metrics_dir: str = 'mining_results/metrics'

    # Plugin list
    plugin_list_file: str = 'top_10k_plugin_slugs.txt'

    # Processing parameters
    max_plugins_to_scan: Optional[int] = None  # None = scan all
    max_revisions_per_plugin: Optional[int] = None  # None = scan all revisions
    min_pattern_confidence: float = 0.7
    parallel_workers: int = 4

    # Pattern matching
    enable_ast_matching: bool = True  # Use AST matching (slower but accurate)
    enable_regex_matching: bool = True  # Use regex matching (faster but less accurate)

    # Temporal analysis
    track_silent_fixes: bool = True  # Track fixes without CVE assignment
    track_vulnerability_inheritance: bool = True  # Track pattern spreading

    # Zero-day detection
    enable_zero_day_detection: bool = True
    zero_day_confidence_threshold: float = 0.8

    # Progress tracking
    progress_file: str = 'mining_results/mining_progress.json'
    save_frequency: int = 10  # Save progress every N plugins

    # Performance
    cache_plugin_histories: bool = True
    cache_dir: str = 'mining_results/cache'

    # Timeouts (in seconds)
    svn_log_timeout: int = 300  # 5 minutes for svn log (large repos like elementor)
    svn_cat_timeout: int = 120  # 2 minutes for svn cat
    svn_list_timeout: int = 120  # 2 minutes for svn list

    def validate(self) -> bool:
        """
        Validate configuration.

        Returns:
            bool: True if valid

        Raises:
            ValueError: If configuration is invalid
        """
        if not os.path.exists(self.svn_repos_dir):
            raise ValueError(f"SVN repos directory not found: {self.svn_repos_dir}")

        if not os.path.exists(self.signatures_dir):
            raise ValueError(f"Signatures directory not found: {self.signatures_dir}")

        if self.min_pattern_confidence < 0 or self.min_pattern_confidence > 1:
            raise ValueError("min_pattern_confidence must be between 0 and 1")

        if self.parallel_workers < 1:
            raise ValueError("parallel_workers must be >= 1")

        return True

    def ensure_directories(self):
        """Create output directories if they don't exist."""
        os.makedirs(self.mining_output_dir, exist_ok=True)
        os.makedirs(self.timelines_dir, exist_ok=True)
        os.makedirs(self.zero_days_dir, exist_ok=True)
        os.makedirs(self.metrics_dir, exist_ok=True)

        if self.cache_plugin_histories:
            os.makedirs(self.cache_dir, exist_ok=True)

    def get_plugin_list(self) -> list:
        """
        Get list of plugins to scan.

        Returns:
            list: Plugin slugs
        """
        if not os.path.exists(self.plugin_list_file):
            raise FileNotFoundError(f"Plugin list not found: {self.plugin_list_file}")

        with open(self.plugin_list_file, 'r') as f:
            plugins = [line.strip() for line in f if line.strip()]

        if self.max_plugins_to_scan:
            return plugins[:self.max_plugins_to_scan]

        return plugins
