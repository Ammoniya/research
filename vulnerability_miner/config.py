"""Configuration for vulnerability mining operations."""

import os
from dataclasses import dataclass
from typing import Optional
from pathlib import Path

# Import centralized data paths
import sys
sys.path.insert(0, str(Path(__file__).parent.parent))
from data_paths import (
    INPUT_PLUGIN_LIST,
    OUTPUT_SIGNATURES_DIR,
    OUTPUT_MINING_DIR,
    MINING_TIMELINES_DIR,
    MINING_ZERO_DAYS_DIR,
    MINING_METRICS_DIR,
    MINING_PROGRESS_FILE,
    MINING_CACHE_DIR,
    ensure_data_directories
)


@dataclass
class MinerConfig:
    """Configuration for historical vulnerability mining."""

    # Input directories
    svn_repos_dir: str = os.environ.get(
        'SVN_REPOS_DIR',
        '/home/ravindu/compweb/svn_wordpress_org'
    )
    signatures_dir: str = str(OUTPUT_SIGNATURES_DIR)

    # Output directories
    mining_output_dir: str = str(OUTPUT_MINING_DIR)
    timelines_dir: str = str(MINING_TIMELINES_DIR)
    zero_days_dir: str = str(MINING_ZERO_DAYS_DIR)
    metrics_dir: str = str(MINING_METRICS_DIR)

    # Plugin list
    plugin_list_file: str = str(INPUT_PLUGIN_LIST)

    # Processing parameters
    max_plugins_to_scan: Optional[int] = None  # None = scan all
    max_revisions_per_plugin: Optional[int] = None  # None = scan all revisions
    scan_mode: str = 'commits'  # 'commits' or 'releases' - releases scans tagged versions only
    min_pattern_confidence: float = 0.7
    parallel_workers: int = 0  # 0 = auto-detect (CPU count * 4 for I/O-bound work)
    verbose: bool = False  # Enable verbose logging

    # Pattern matching
    enable_ast_matching: bool = True  # Use AST matching (slower but accurate)
    enable_regex_matching: bool = True  # Use regex matching (faster but less accurate)

    # Temporal analysis
    track_silent_fixes: bool = True  # Track fixes without CVE assignment
    track_vulnerability_inheritance: bool = True  # Track pattern spreading

    # Zero-day detection
    enable_zero_day_detection: bool = True
    zero_day_confidence_threshold: float = 0.8

    # Progress tracking
    progress_file: str = str(MINING_PROGRESS_FILE)
    save_frequency: int = 10  # Save progress every N plugins

    # Performance
    cache_plugin_histories: bool = True
    cache_dir: str = str(MINING_CACHE_DIR)

    # Timeouts (in seconds)
    svn_log_timeout: int = 300  # 5 minutes for svn log (large repos like elementor)
    svn_cat_timeout: int = 120  # 2 minutes for svn cat
    svn_list_timeout: int = 120  # 2 minutes for svn list

    def validate(self) -> bool:
        """
        Validate configuration.

        Returns:
            bool: True if valid

        Raises:
            ValueError: If configuration is invalid
        """
        if not os.path.exists(self.svn_repos_dir):
            raise ValueError(f"SVN repos directory not found: {self.svn_repos_dir}")

        if not os.path.exists(self.signatures_dir):
            raise ValueError(f"Signatures directory not found: {self.signatures_dir}")

        if self.min_pattern_confidence < 0 or self.min_pattern_confidence > 1:
            raise ValueError("min_pattern_confidence must be between 0 and 1")

        if self.parallel_workers < 1:
            raise ValueError("parallel_workers must be >= 1")

        if self.scan_mode not in ['commits', 'releases']:
            raise ValueError("scan_mode must be 'commits' or 'releases'")

        return True

    def ensure_directories(self):
        """Create output directories if they don't exist."""
        # Use centralized directory creation
        ensure_data_directories()

    def get_plugin_list(self) -> list:
        """
        Get list of plugins to scan.

        Returns:
            list: Plugin slugs
        """
        if not os.path.exists(self.plugin_list_file):
            raise FileNotFoundError(f"Plugin list not found: {self.plugin_list_file}")

        with open(self.plugin_list_file, 'r') as f:
            plugins = [line.strip() for line in f if line.strip()]

        if self.max_plugins_to_scan:
            return plugins[:self.max_plugins_to_scan]

        return plugins
