"""Zero-day vulnerability detector."""

import os
import json
from typing import List, Dict, Optional
from datetime import datetime

from .models import ZeroDayFinding
from .pattern_matcher import SignaturePattern


class ZeroDayDetector:
    """Detects potential zero-day vulnerabilities in current plugin versions."""

    def __init__(
        self,
        confidence_threshold: float = 0.8,
        output_dir: str = "mining_results/zero_days"
    ):
        """
        Initialize zero-day detector.

        Args:
            confidence_threshold: Minimum confidence for zero-day findings
            output_dir: Directory for zero-day reports
        """
        self.confidence_threshold = confidence_threshold
        self.output_dir = output_dir
        os.makedirs(output_dir, exist_ok=True)

    def detect_in_current_version(
        self,
        plugin_slug: str,
        current_version: str,
        current_code: str,
        signature_pattern: SignaturePattern,
        pattern_matches: List[Dict]
    ) -> Optional[ZeroDayFinding]:
        """
        Detect if current version has vulnerability pattern.

        Args:
            plugin_slug: Plugin slug
            current_version: Current version
            current_code: Current code content
            signature_pattern: Signature pattern
            pattern_matches: Matches found in current code

        Returns:
            Optional[ZeroDayFinding]: Zero-day finding if detected
        """
        if not pattern_matches:
            return None

        # Calculate average confidence
        avg_confidence = sum(m['confidence'] for m in pattern_matches) / len(pattern_matches)

        if avg_confidence < self.confidence_threshold:
            return None

        # Extract match details
        matched_files = list(set(m['file_path'] for m in pattern_matches))
        matched_code_snippets = [m['line_content'] for m in pattern_matches[:5]]  # First 5

        # Create zero-day finding
        finding = ZeroDayFinding(
            plugin_slug=plugin_slug,
            current_version=current_version,
            signature_id=signature_pattern.signature_id,
            original_cve=signature_pattern.signature_id if signature_pattern.signature_id.startswith('CVE-') else None,
            vulnerability_type=signature_pattern.vuln_type,
            pattern=signature_pattern.pattern_string,
            confidence=avg_confidence,
            matched_files=matched_files,
            matched_code_snippets=matched_code_snippets,
            exploitability_score=signature_pattern.exploitability_score
        )

        return finding

    def verify_zero_day(
        self,
        finding: ZeroDayFinding,
        known_cves: List[str]
    ) -> bool:
        """
        Verify if finding is truly a zero-day.

        Args:
            finding: Zero-day finding
            known_cves: List of known CVEs for this plugin

        Returns:
            bool: True if verified as zero-day
        """
        # If this CVE is already known for this plugin, not a zero-day
        if finding.original_cve in known_cves:
            return False

        # Additional verification logic could go here
        # For now, high confidence patterns are considered verified
        return finding.confidence >= self.confidence_threshold

    def prioritize_findings(
        self,
        findings: List[ZeroDayFinding]
    ) -> List[ZeroDayFinding]:
        """
        Prioritize zero-day findings by risk.

        Args:
            findings: List of findings

        Returns:
            List[ZeroDayFinding]: Prioritized findings
        """
        # Calculate priority score
        def priority_score(finding: ZeroDayFinding) -> float:
            score = finding.confidence * 0.4
            score += (finding.exploitability_score / 10.0) * 0.4
            score += (1.0 if finding.is_exact_clone else 0.5) * 0.2
            return score

        # Sort by priority
        return sorted(
            findings,
            key=priority_score,
            reverse=True
        )

    def save_finding(self, finding: ZeroDayFinding):
        """
        Save zero-day finding to file.

        Args:
            finding: Finding to save
        """
        filename = f"{finding.plugin_slug}_{finding.signature_id}.json"
        filepath = os.path.join(self.output_dir, filename)

        with open(filepath, 'w') as f:
            json.dump(finding.to_dict(), f, indent=2)

    def save_all_findings(self, findings: List[ZeroDayFinding]):
        """
        Save all findings to consolidated file.

        Args:
            findings: All findings
        """
        filepath = os.path.join(self.output_dir, "zero_day_findings.json")

        findings_data = {
            'metadata': {
                'generated_at': datetime.now().isoformat(),
                'total_findings': len(findings),
                'high_confidence_count': sum(1 for f in findings if f.confidence >= 0.9),
            },
            'findings': [f.to_dict() for f in findings]
        }

        with open(filepath, 'w') as f:
            json.dump(findings_data, f, indent=2)

    def generate_disclosure_report(
        self,
        finding: ZeroDayFinding
    ) -> str:
        """
        Generate responsible disclosure report.

        Args:
            finding: Zero-day finding

        Returns:
            str: Formatted disclosure report
        """
        report = []
        report.append("=" * 80)
        report.append("POTENTIAL ZERO-DAY VULNERABILITY - RESPONSIBLE DISCLOSURE REPORT")
        report.append("=" * 80)
        report.append("")

        report.append("PLUGIN INFORMATION")
        report.append("-" * 80)
        report.append(f"Plugin Slug:       {finding.plugin_slug}")
        report.append(f"Current Version:   {finding.current_version}")
        report.append("")

        report.append("VULNERABILITY DETAILS")
        report.append("-" * 80)
        report.append(f"Type:              {finding.vulnerability_type}")
        report.append(f"Pattern Signature: {finding.pattern}")
        report.append(f"Confidence:        {finding.confidence:.2%}")
        report.append(f"Exploitability:    {finding.exploitability_score:.1f}/10")
        report.append("")

        if finding.original_cve:
            report.append("SIMILAR KNOWN VULNERABILITY")
            report.append("-" * 80)
            report.append(f"Reference CVE:     {finding.original_cve}")
            report.append(f"Clone Type:        {'Exact' if finding.is_exact_clone else 'Similar'}")
            report.append("")

        report.append("AFFECTED FILES")
        report.append("-" * 80)
        for i, file_path in enumerate(finding.matched_files, 1):
            report.append(f"{i}. {file_path}")
        report.append("")

        report.append("CODE EVIDENCE")
        report.append("-" * 80)
        for i, snippet in enumerate(finding.matched_code_snippets, 1):
            report.append(f"{i}. {snippet}")
        report.append("")

        report.append("RECOMMENDED ACTIONS")
        report.append("-" * 80)
        report.append("1. Verify the vulnerability in a test environment")
        report.append("2. Contact plugin author through WordPress.org")
        report.append("3. If no response in 7 days, escalate to WordPress security team")
        report.append("4. Coordinate disclosure timeline (typically 90 days)")
        report.append("")

        report.append("WORDPRESS SECURITY CONTACTS")
        report.append("-" * 80)
        report.append("Plugin Security: plugins@wordpress.org")
        report.append("Core Security:   security@wordpress.org")
        report.append("Wordfence:       https://www.wordfence.com/threat-intel/vulnerabilities/")
        report.append("")

        report.append("=" * 80)
        report.append(f"Generated: {datetime.now().isoformat()}")
        report.append("=" * 80)

        return "\n".join(report)

    def generate_summary_report(
        self,
        findings: List[ZeroDayFinding]
    ) -> str:
        """
        Generate summary report of all findings.

        Args:
            findings: All findings

        Returns:
            str: Formatted summary
        """
        report = []
        report.append("=" * 80)
        report.append("ZERO-DAY VULNERABILITY DISCOVERY SUMMARY")
        report.append("=" * 80)
        report.append("")

        report.append("SUMMARY STATISTICS")
        report.append("-" * 80)
        report.append(f"Total Findings:          {len(findings)}")
        report.append(f"High Confidence (>90%):  {sum(1 for f in findings if f.confidence >= 0.9)}")
        report.append(f"Exact Clones:            {sum(1 for f in findings if f.is_exact_clone)}")
        report.append("")

        # Vulnerability type breakdown
        vuln_types = {}
        for f in findings:
            vuln_types[f.vulnerability_type] = vuln_types.get(f.vulnerability_type, 0) + 1

        report.append("VULNERABILITY TYPE BREAKDOWN")
        report.append("-" * 80)
        for vuln_type, count in sorted(vuln_types.items(), key=lambda x: x[1], reverse=True):
            report.append(f"{vuln_type:50s} {count:>3}")
        report.append("")

        # Top findings
        prioritized = self.prioritize_findings(findings)

        report.append("TOP 10 HIGH-PRIORITY FINDINGS")
        report.append("-" * 80)
        for i, finding in enumerate(prioritized[:10], 1):
            report.append(f"{i}. {finding.plugin_slug} v{finding.current_version}")
            report.append(f"   Type: {finding.vulnerability_type}")
            report.append(f"   Confidence: {finding.confidence:.2%}, Exploitability: {finding.exploitability_score:.1f}/10")
            report.append(f"   Files: {len(finding.matched_files)}")
            report.append("")

        report.append("=" * 80)
        report.append(f"Generated: {datetime.now().isoformat()}")
        report.append("=" * 80)

        return "\n".join(report)
