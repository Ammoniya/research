"""Main signature generation orchestrator."""

import json
from typing import List, Optional
from datetime import datetime
from collections import defaultdict

from .models import VulnerabilityInfo, CodeSignature, ProcessingStats
from .svn_extractor import SVNDiffExtractor
from .progress_manager import ProgressManager, SignatureStorage
from .config import Config


class SignatureGenerator:
    """Orchestrates simple diff extraction from vulnerabilities."""

    def __init__(self, config: Config):
        """
        Initialize signature generator.

        Args:
            config: Configuration object
        """
        self.config = config
        self.svn_extractor = SVNDiffExtractor(
            config.svn_repos_dir,
            config.diff_timeout
        )
        self.progress_manager = ProgressManager(config.progress_file)
        self.signature_storage = SignatureStorage(config.signatures_output_dir)

    def generate_signature(
        self,
        vuln_info: VulnerabilityInfo,
        diff_content: str,
        vuln_version: str,
        fixed_version: str
    ) -> Optional[CodeSignature]:
        """
        Generate simplified signature from vulnerability and diff.

        Args:
            vuln_info: Vulnerability information
            diff_content: Diff content string
            vuln_version: Vulnerable version tag
            fixed_version: Fixed version tag

        Returns:
            Optional[CodeSignature]: Generated signature or None
        """
        if not diff_content:
            return None

        # Parse diff into blocks to extract pre/post code
        diff_blocks = self.svn_extractor.parse_diff_to_blocks(diff_content)

        if not diff_blocks:
            return None

        # Get diff statistics
        diff_stats = self.svn_extractor.get_diff_stats(diff_blocks)

        # Extract pre-patch and post-patch code
        pre_patch_code = self._extract_code(diff_blocks, 'before')
        post_patch_code = self._extract_code(diff_blocks, 'after')

        # Create simplified signature
        signature = CodeSignature(
            cve=vuln_info.cve,
            plugin_slug=vuln_info.plugin_slug,
            vuln_type=vuln_info.vuln_type,
            title=vuln_info.title,
            wordfence_uuid=vuln_info.wordfence_uuid,
            vulnerable_version=vuln_version,
            patched_version=fixed_version,
            affected_versions=vuln_info.affected_versions,
            patch_location=f"{vuln_version} -> {fixed_version}",
            pre_patch_code=pre_patch_code,
            post_patch_code=post_patch_code,
            unified_diff=diff_content,
            files_changed=diff_stats['file_changes'],
            lines_added=diff_stats['total_lines_added'],
            lines_removed=diff_stats['total_lines_removed'],
            references=vuln_info.references,
        )

        return signature

    def _extract_code(self, diff_blocks: List, code_type: str) -> str:
        """
        Extract code from diff blocks.

        Args:
            diff_blocks: List of DiffBlock objects
            code_type: 'before' or 'after'

        Returns:
            str: Concatenated code from all blocks
        """
        snippets = []
        for block in diff_blocks:
            if code_type == 'before' and block.before_code:
                snippets.append(f"=== File: {block.file_path} ===\n{block.before_code}")
            elif code_type == 'after' and block.after_code:
                snippets.append(f"=== File: {block.file_path} ===\n{block.after_code}")

        return '\n\n'.join(snippets)

    def save_consolidated_signatures(self, output_file: str):
        """
        Save all signatures to consolidated JSON file.

        Args:
            output_file: Path to output file
        """
        signatures = self.signature_storage.load_all_signatures()

        with open(output_file, 'w') as f:
            json.dump({
                'metadata': {
                    'generated_at': datetime.now().isoformat(),
                    'total_signatures': len(signatures),
                    'version': '3.0.0-simplified'
                },
                'signatures': signatures
            }, f, indent=2)

    def generate_statistics(self) -> dict:
        """
        Generate statistics from all signatures.

        Returns:
            dict: Statistics dictionary
        """
        signatures = self.signature_storage.load_all_signatures()

        vuln_type_counts = defaultdict(int)
        total_files_changed = 0
        total_lines_added = 0
        total_lines_removed = 0

        for sig in signatures:
            vuln_type_counts[sig['vuln_type']] += 1
            total_files_changed += sig.get('files_changed', 0)
            total_lines_added += sig.get('lines_added', 0)
            total_lines_removed += sig.get('lines_removed', 0)

        return {
            'total_signatures': len(signatures),
            'vuln_type_distribution': dict(vuln_type_counts),
            'avg_files_changed': total_files_changed / len(signatures) if signatures else 0,
            'avg_lines_added': total_lines_added / len(signatures) if signatures else 0,
            'avg_lines_removed': total_lines_removed / len(signatures) if signatures else 0,
        }
