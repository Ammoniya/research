"""Configuration management for vulnerability analyzer."""

import os
from pathlib import Path
from typing import Optional


class Config:
    """Configuration settings for the vulnerability analyzer."""

    def __init__(
        self,
        svn_repos_dir: Optional[str] = None,
        vulnerabilities_file: Optional[str] = None,
        signatures_output_dir: Optional[str] = None,
        progress_file: Optional[str] = None,
        wordfence_api_base: Optional[str] = None
    ):
        """
        Initialize configuration.

        Args:
            svn_repos_dir: Directory containing local SVN repositories
            vulnerabilities_file: Path to vulnerability JSON file
            signatures_output_dir: Directory for signature output
            progress_file: Path to progress tracking file
            wordfence_api_base: Wordfence API base URL
        """
        # SVN repository location
        self.svn_repos_dir = Path(
            svn_repos_dir or os.getenv(
                'SVN_REPOS_DIR',
                '/home/ravindu/compweb/svn_wordpress_org'
            )
        )

        # Input/Output files
        self.vulnerabilities_file = vulnerabilities_file or "plugin_vulnerabilities.json"
        self.signatures_output_dir = signatures_output_dir or "signatures"
        self.signatures_consolidated_file = "vulnerability_signatures.json"
        self.progress_file = progress_file or "processing_progress.json"

        # API configuration
        self.wordfence_api_base = (
            wordfence_api_base or
            "https://www.wordfence.com/api/intelligence/v2/vulnerabilities"
        )

        # Processing configuration
        self.progress_save_frequency = 10  # Save progress every N vulnerabilities
        self.diff_timeout = 30  # Timeout for diff operations in seconds
        self.remote_checkout_timeout = 120  # Timeout for SVN checkout

        # Pattern detection thresholds
        self.min_confidence_score = 0.7  # Minimum confidence to include pattern
        self.max_diff_files = 50  # Warn if diff includes more than this many files

    def ensure_directories(self):
        """Create necessary directories if they don't exist."""
        os.makedirs(self.signatures_output_dir, exist_ok=True)

    def validate(self) -> bool:
        """
        Validate configuration.

        Returns:
            bool: True if configuration is valid

        Raises:
            ValueError: If configuration is invalid
        """
        if not self.svn_repos_dir.exists():
            raise ValueError(f"SVN repository directory not found: {self.svn_repos_dir}")

        if not Path(self.vulnerabilities_file).exists():
            raise ValueError(f"Vulnerabilities file not found: {self.vulnerabilities_file}")

        return True
